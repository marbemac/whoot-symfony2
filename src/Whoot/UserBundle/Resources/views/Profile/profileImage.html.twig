{% set w = width is defined ? width : dimensions %}
{% set h = height is defined ? height : dimensions %}

{% if user.profileImage %}
    {% set src = '/slir/w'~w~'-h'~h~'-c1:1'~user.profileImage %}
{% elseif user.facebookId %}
    {% if w <= 50 %}
        {% set type = 'square' %}
    {% elseif w <= 100 %}
        {% set type = 'small' %}
    {% else %}
        {% set type = 'normal' %}
    {% endif %}
    {% set src = 'https://graph.facebook.com/'~user.facebookId~'/picture?type='~type %}
{% else %}
    {% set src = gravatar(user.profileImage, dimensions, 'r', 'mm') %}
{% endif %}

<img class="profileImage" width="{{ w }}" {{ id is defined ? 'id="'~id~'"' : '' }} src="{{ src }}" />